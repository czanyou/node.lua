# 传感器数据

[TOC]

由于我们的设备要支持各种各用的传感器, 但我们想要用一套代码来统一处理各种各样的数据, 
所以我们想简单地为数据定义数据流和数据点的概念.

## 状态

正在设计中, 随时可能修改设计

## 数据采集规则

传感器采集和记录需要考虑到多个因素

- 功耗，特别对于采用电池供电的设备要考虑采样间隔
- 空间占用，当记录过多时，会占用大量数据库空间，或者查询时占用过多时间
- 带宽占用，当记录过多时，会消耗过多的流量
- 变化率，有些数据可能很长时间内不会太大波动，可以适当延时采集间隔
- 方便统计，记录数据是为了统计和分析，所以保存数据时考虑进去
- 智能记录，可以综合多个传感器数据来预测设备的状态，以便采用相匹配的记录方式，比如通过光照传感器判断是不是晚上，通过重力传感器判断设备是否静止状态。

## 数据流

一个设备可以包含多个传感器, 并采集多种数据, 我们将每种传感器产生的数据定义为一个数据流.
这样, 一个设备可以包含多个数据流.

常见的数据流会有以下类型:

- 视频流
- 音频流
- 图片流
- GPS 位置
- 温度
- 湿度
- 光照
- 开关报警
- 气体浓度
- 其他

数据流的属性

- 设备 ID
- 流的 ID (可以用名称代替, 但在设备范围内必须唯一)
- 数值单位 (可选)

数据流的分类

- 文件类数据流, 比如图片,视频, 音频等等
- 单一数值类数据流, 如温度,湿度,光照,开关报警,气体浓度
- 复合型数值类数据流, 如 GPS 位置, 一个数据点至少包含经度, 纬度以及高度等信息

## 数据点

一个数据流的每一次采样, 即为一个数据点, 比如:

- 一张图片
- 一段视频录像文件
- 一段录音文件
- 一个温度值
- 一个 GPS 坐标
- 一次开或关的变化
- 等等

### 数据点属性

- 设备 ID
- 数据流 ID
- 数据值
- 采样时间 (可选)
- 采样序号 (可选)

### 文件型数据值

- 文件保存在云存储服务器或者其他位置, 数据库中只保存文件的 url 或索引值

### 二进制型数据值

- 数据库保存以 base64 编码的数据值

### 字符串数据值

- 数据库直接保存字符串数据值

### 数值型数据值

- 数据库直接保存数值数据值

### 复合型数据值

- 数据库直接保存 JSON 格式的复合型数据值

## 本地数据库格式

本地目前只支持以 sqlite 数据库来保存数据流

保存数据流的表结构为:

| Name          | Type      | Description
| ---           | ---       | ---
| id            | INT       | 数据点 ID, 递增, 唯一
| stream        | TEXT      | 数据流类型
| value         | TEXT      | 数据值
| seq           | INT       | 序列号 (可选, 递增)
| timestamp     | INT       | 时间戳 (从 1970 年 1 月 1 日以来经过的毫秒数)

### 通过命令行添数据点

`lpm sensor add <stream> <value>`

### 通过命令行查询数据流

`lpm sensor find <mode> <offset>`

### 查询接口

`data.list`



### 数据统计

#### 统计周期 

- 日 (day) 统计当天 24 小时数据, 每小时一个采样点
- 周 (week) 统计过去 7 天数据, 每天一个采样点
- 月 (month) 统计过去 31 天数据, 每天一个采样点
- 年 (year) 统计过去 1 年数据, 每月一个采样点

#### 采样模式

数值型数据流实际上是随时间变化的曲线，比如温度等等，所以可以定义一个通用的模型和接口来查询此类数据。

- 平均值 (avg) 每个统计时间段内数据点的平均值, 如一天的平均温度
- 最大值 (max) 每个统计时间段内数据点的最大值, 如一天的最高温度
- 最小值 (min) 每个统计时间段内数据点的最大值, 如一天的最低温度
- 累计值 (total) 每个统计时间段内数据点的累计值, 如一天的总共走的步数
- 记录数 (count) 每个统计时间段内数据点的记录数, 如一天的访问次数

#### 返回结果数据格式

```json
{
  "ret":0,
  "data": {
    "title":"temperature",
    "mode": "month",
    "labels": [9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,1,2,3,4,5,6,7,8],
    "series": [
      {
        "type":"max",
        "unit":"C",
        "name":"tempareture",
        "data": [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,"28.4","28.1","32","31.8","31.1","32.9","34.5","32.2","32.9","30.6","27.7","32.4","28.8","25.9","26.9","27.5","29.3","30.5","29.5",-1]
      },
      {
        "type":"min",
        "unit":"C",
        "name":"tempareture",
        "data": [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,"28.2","26.4","27.2","27.3","27.7","28","28.1","28","28.2","26.8","23.7","23.8","23.9","22.1","21","20.1","22.3","23.6","24",-1]
      }
    ]
  }
}
```

- date.title 标题，暂未使用
- data.labels[] 采样点标签，一般以时间点为标签
- data.series[] 数据流集合
- data.series[x].unit 这个数据流统计点数值的单位
- data.series[x].name 这个数据流的名称
- data.series[x].type 这个数据流的统计类型
- data.series[x].data[] 这个数据流的统计点集合

##### 占位符

有时统计时间段内可能没有记录数据，暂时用 -1 表示这个时间段没有数据，同时在画图的时候不作显示。

#### 缓存

统计结果可以缓存起来，以便提高统计效率

## 数据上传格式

### 上传单个数据点

```json
{
    "device_id": 123456,
    "nonce": "a38gf0",
    "sign": "349sdk3lgasdf0934jh",
    "timestamp": 1491660090,
    "data": {
        "type": "temperature",
        "at": 1491660090,
        "value": 25.5
    }
}

```

### 上传多个数据点

```json
{
    "device_id": 123456,
    "nonce": "a38gf0",
    "sign": "349sdk3lgasdf0934jh",
    "timestamp": 1491660090,
    "data": [
        {
            "type": "temperature",
            "at": 1491660090,
            "value": 25.5
        }, 
        {
            "type": "temperature",           
            "at": 1491660090,
            "value": 26.5
        }
    ]
}

```

### 上传复合型数据

```json
{
    "device_id": 123456,
    "nonce": "a38gf0",
    "sign": "349sdk3lgasdf0934jh",
    "timestamp": 1491660090,
    "mac": "00:11:22:33:AA:BB",
    "data": [
        {
            "type": "beacon",
            "at": 1491660090,
            "tid": "00:11:22:33:AA:BB",
            "distance": 5.5
        },
        {
            "type": "beacon",
            "at": 1491660090,
            "tid": "00:11:22:33:AA:BB",
            "distance": 6.5
        }
    ]
}

```

- mac Bluetooth Host ID
- tid iBeacon ID
- beacon Bluetooth beacon cell location

```
sign = md5_hash(nonce + ':' + timestamp + ':' + key)
```


在服务端, 如果收到重复的时间戳的数据点, 则覆盖之.

### 数值型数据查询

| 参数	    | 必选 	| 类型及范围	| 说明
| ---       | ---   | ---
| type	    | true	| String	| day,week,month,year
| offset	| true	| String	| ...-10,-9,-8...0 (0 当前时间段, -1 上一个时间段，以此类推)
| stream	| true  | array	    | 比如 tempareture,humity 要取的数据字段


查询返回结果如下:

```json
{
    "code"   : "200",
    "result" : "成功",
    "api" : "/device/data/data_chart",
    "date" :{
        "lable":{
            "array":[1,2,3,4...24],          // 这个代表x轴坐标
            "unit":h
        },
        "series": [                           // 这个代表线段条数，如下有两条
            {
                "array":[27.4,23.5,26.4,...,27.6],    //这个代表线段数组
                "unit":"度",
                "name":"tempareture",
                "way":"max"                   //这个代表最大值
            },
            {
                "array":[56,54,57...58],
                "unit":"%",
                "name":"humity",
                "way":"avg"                  // 这个代表平均值
            }
        ],
        "title":"XXX"        // 这个字段暂时保留
    }
}

```
